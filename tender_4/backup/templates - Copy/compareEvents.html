<!DOCTYPE html>
<html>
<head>
    <title>Compare Events - AI Insights</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css">

    <!-- UI references: page2.jpg, page2b.jpg -->
    <script>
      function showAllInsights(eventId) {
          let block = document.getElementById('insights-' + eventId);
          let button = document.getElementById('btn-' + eventId);
          if (block.style.display === 'none') {
              block.style.display = 'block';
              button.innerHTML = 'Collapse';
          } else {
              block.style.display = 'none';
              button.innerHTML = 'Extend';
          }
      }

      function fetchAIInsights(eventId) {
          fetch(`/ai_insights/${eventId}`)
          .then(response => response.json())
          .then(data => {
              console.log("AI Insights:", data);
              let insightsBlock = document.getElementById('insights-' + eventId);
              insightsBlock.innerHTML = `
                  <p><strong>Trends:</strong> ${data.ai_insights.trends.join(', ')}</p>
                  <p><strong>Optimizations:</strong> ${data.ai_insights.optimizations.join(', ')}</p>
              `;
              showAllInsights(eventId);
          })
          .catch(error => console.error('Error:', error));
      }
    </script>
</head>
<body>
<div class="container mt-4">
    <h2>Similar Sourcing Project by {{ form_data.get('project_name', 'Unknown') }}</h2>
    <p><strong>Description:</strong> {{ form_data.get('description') }}</p>
    <p><strong>Project Type:</strong> {{ form_data.get('project_type') }}</p>
    <p><strong>Commodity:</strong> {{ form_data.get('commodity') }}</p>

    <hr>
    <h3>AI Insights for Events</h3>
    {% for event in events %}
    <div class="card mb-3 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>{{ event.Title if event.Title else event.EventID }}</h5>
            <button class="btn btn-sm btn-outline-info" id="btn-{{ event.EventID }}" onclick="fetchAIInsights('{{ event.EventID }}')">Extend</button>
        </div>
        <div class="card-body">
            {% if event.ai_data %}
                <p><strong>Score:</strong> {{ event.ai_data.score }}</p>
                <p><strong>Reason:</strong> {{ event.ai_data.reason }}</p>
                <p><strong>Explanation:</strong> {{ event.ai_data.explanation }}</p>
                <p><strong>Match Score:</strong> {{ event.ai_data.match_score }}</p>
                <p><strong>Region:</strong> {{ event.ai_data.region }}</p>
                <p><strong>Risks:</strong> {{ event.ai_data.risks }}</p>
                <div id="insights-{{ event.EventID }}" style="display:none;">
                    <p><strong>Trends:</strong> {{ event.ai_data.ai_insights.trends|join(', ') }}</p>
                    <p><strong>Optimizations:</strong> {{ event.ai_data.ai_insights.optimizations|join(', ') }}</p>
                </div>
            {% else %}
                <p>No AI insights available for this event.</p>
            {% endif %}
            <a href="{{ url_for('compare_quotes', event_id=event.EventID) }}" class="btn btn-success">Compare Quotes</a>
        </div>
    </div>
    {% endfor %}

    <hr>
    <h4>AI (Global) Insights</h4>
    <ul class="nav nav-tabs" id="globalInsightsTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="trends-tab" data-bs-toggle="tab" data-bs-target="#globalTrends" type="button" role="tab">Trends</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="risks-tab" data-bs-toggle="tab" data-bs-target="#globalRisks" type="button" role="tab">Risks</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="optimizations-tab" data-bs-toggle="tab" data-bs-target="#globalOptimizations" type="button" role="tab">Optimizations</button>
      </li>
    </ul>
    <div class="tab-content mt-3">
      <div id="globalTrends" class="tab-pane fade show active" role="tabpanel">
        <p>{{ global_insights.trends|join(', ') }}</p>
      </div>
      <div id="globalRisks" class="tab-pane fade" role="tabpanel">
        <p>{{ global_insights.risks|join(', ') }}</p>
      </div>
      <div id="globalOptimizations" class="tab-pane fade" role="tabpanel">
        <p>{{ global_insights.optimizations|join(', ') }}</p>
      </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
