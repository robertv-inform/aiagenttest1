import os
import csv
import json
import numpy as np
import faiss
from flask import Flask, render_template, request, jsonify
from sentence_transformers import SentenceTransformer

# Uncomment below to enable OpenAI GPT-4 Calls
# import openai  

# --------------------------------------------------------------------
# Check and Download AllMiniLM-L6-v2 Model
# --------------------------------------------------------------------
MODEL_PATH = "model_repo/all-MiniLM-L6-v2"
MODEL_NAME = "sentence-transformers/all-MiniLM-L6-v2"

def download_model_if_needed():
    """Checks if model exists; if not, downloads it."""
    if not os.path.exists(MODEL_PATH):
        print("üîπ Model not found. Downloading AllMiniLM-L6-v2...")
        model = SentenceTransformer(MODEL_NAME)
        model.save(MODEL_PATH)
        print("‚úÖ Model downloaded and saved at:", MODEL_PATH)
    else:
        print("‚úÖ Model already present. Loading from", MODEL_PATH)

# Ensure model is available before running app
download_model_if_needed()

# Load the AllMiniLM-L6-v2 model
embedding_model = SentenceTransformer(MODEL_PATH)
EMBEDDING_DIM = embedding_model.get_sentence_embedding_dimension()

app = Flask(__name__)

# --------------------------------------------------------------------
# GLOBAL VARIABLES
# --------------------------------------------------------------------
EVENT_INDEX = None
EVENT_EMBEDDINGS = None
EVENTS_DATA = []

SUPPLIER_INDEX = None
SUPPLIER_EMBEDDINGS = None
SUPPLIER_DATA = []

# --------------------------------------------------------------------
# FAISS Vector Search Setup
# --------------------------------------------------------------------
def build_faiss_index_for_events(csv_path):
    """Loads events, generates embeddings, and builds FAISS index."""
    global EVENT_INDEX, EVENT_EMBEDDINGS, EVENTS_DATA

    events = []
    try:
        with open(csv_path, newline='', encoding="utf-8") as f:
            reader = csv.DictReader(f)
            for row in reader:
                events.append(row)
    except Exception as e:
        print("‚ùå Error loading event data:", e)
        return

    if not events:
        print("‚ùå No events found in CSV.")
        return

    # Compute embeddings using AllMiniLM-L6-v2
    texts = [" ".join([e.get("Title", ""), e.get("Description", ""), e.get("Commodity", "")]) for e in events]
    embeddings = embedding_model.encode(texts, convert_to_numpy=True)

    # Create FAISS index
    index = faiss.IndexFlatL2(EMBEDDING_DIM)
    index.add(embeddings)

    # Store results globally
    EVENT_INDEX = index
    EVENT_EMBEDDINGS = embeddings
    EVENTS_DATA = events

def faiss_search_events(query_text, top_k=10):
    """Searches FAISS index for top_k matching events."""
    if EVENT_INDEX is None:
        print("‚ùå FAISS index not built.")
        return []

    query_emb = embedding_model.encode([query_text], convert_to_numpy=True)
    distances, indices = EVENT_INDEX.search(query_emb, top_k)

    return [EVENTS_DATA[idx] for idx in indices[0] if idx < len(EVENTS_DATA)]

# --------------------------------------------------------------------
# Dummy GPT-4 Functions (Actual API Call is Commented)
# --------------------------------------------------------------------

def dummy_gpt4_event_insights(event):
    """Returns dummy AI insights for an event."""
    return {
        "score": np.random.randint(70, 99),
        "reason": "High potential synergy",
        "explanation": "This event matches the commodity requirements closely.",
        "match_score": round(np.random.rand(), 2),
        "region": event.get("Region", "Unknown"),
        "risks": "Minimal supply chain risk",
        "ai_insights": {
            "trends": ["Growing demand in the APAC region."],
            "optimizations": ["Establish long-term contracts for stability."]
        }
    }

# Uncomment below to enable OpenAI GPT-4 Calls
"""
def call_gpt4_for_events(events_chunk, user_form_data):
    prompt = f\"\"\"Analyze these events and provide insights:
    {events_chunk}
    User input: {user_form_data}
    Provide insights in JSON format.
    \"\"\"

    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=[{"role": "user", "content": prompt}],
        max_tokens=2000,
        temperature=0
    )
    return response["choices"][0]["message"]["content"]
"""

# --------------------------------------------------------------------
# Flask Routes
# --------------------------------------------------------------------
@app.before_first_request
def initialize_indices():
    """Loads FAISS index before the first request."""
    csv_path = os.path.join("data", "small_tender_system_event_data.csv")
    build_faiss_index_for_events(csv_path)

@app.route("/")
def index():
    """Home page route."""
    return render_template("index.html")

@app.route("/generate_project", methods=["POST"])
def generate_project():
    """Handles project creation and AI event matching."""
    form_data = request.form.to_dict()
    commodity = form_data.get("commodity", "").strip()

    matched_events = faiss_search_events(commodity, top_k=50)

    for evt in matched_events:
        evt["ai_data"] = dummy_gpt4_event_insights(evt)

    matched_events.sort(key=lambda x: x["ai_data"]["score"], reverse=True)

    global_insights = {
        "trends": ["Global demand for sustainable solutions."],
        "risks": ["Potential raw material shortages."],
        "optimizations": ["Leverage multi-year contracts for price stability."]
    }

    return render_template("compareEvents.html", events=matched_events, global_insights=global_insights, form_data=form_data)

@app.route("/event_details/<event_id>")
def event_details(event_id):
    """Shows event details."""
    event = next((e for e in EVENTS_DATA if e.get("EventID") == event_id), None)
    return render_template("event_details.html", event=event)

@app.route("/quotation_ai/<event_id>")
def quotation_ai(event_id):
    """Handles supplier AI insights."""
    return render_template("quotation_ai.html", event_id=event_id)

@app.route("/compare_quotes/<event_id>")
def compare_quotes(event_id):
    """Shows supplier AI comparison."""
    supplier_insights_list = dummy_gpt4_supplier_insights()
    return render_template("compare_quotes.html", event_id=event_id, supplier_insights_list=supplier_insights_list)

@app.route("/award", methods=["POST"])
def award():
    """Handles awarding of suppliers."""
    selected_suppliers = request.form.getlist("selected_suppliers")
    return render_template("award_result.html", awarded_suppliers=selected_suppliers)

# Run Flask App
if __name__ == "__main__":
    app.run(debug=True)
